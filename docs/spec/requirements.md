# 要求仕様書: パフォーマンスモニタ解析ツール (PerfmonAnalyzer)

**バージョン**: 1.0（草案）  
**作成日**: 2026年1月31日  
**ステータス**: レビュー待ち

---

## 1. 概要

### 1.1 目的

本ツールは、Windows パフォーマンスモニタ（Perfmon）で取得した CSV データを解析し、以下の問題を早期に検出・可視化することを目的とする。

- **メモリリーク検出**: Private Bytes の時系列推移と増加傾向を分析
- **オブジェクトリーク検出**: Handle Count の時系列推移と増加傾向を分析

### 1.2 背景

手動での Perfmon データ解析は時間がかかり、傾向の見落としが発生しやすい。本ツールにより、グラフ表示・傾き算出・閾値判定を自動化し、リーク検出の効率と精度を向上させる。

### 1.3 スコープ

| 範囲 | 内容 |
|------|------|
| **MVP（フェーズ1）** | CSV読み込み、時系列グラフ表示、範囲選択、傾き算出、画像出力、Web UI |
| **フェーズ2（将来）** | 自動収集ワークフロー、自動レポート出力、複数ファイル比較 |

---

## 2. 用語定義

| 用語 | 定義 |
|------|------|
| **Private Bytes** | プロセスが排他的に使用しているメモリ量（バイト単位） |
| **Handle Count** | プロセスが保持しているオブジェクトハンドルの数 |
| **傾き** | 時系列データの一次近似（線形回帰）における増加率。単位は **KB/10min** |
| **傾き閾値** | 傾きがこの値を超えた場合に警告を表示する基準値。初期値は **50 KB/10min** |
| **サンプリング周期** | Perfmon がデータを取得する間隔。本プロジェクトでは **1分** を標準とする |

---

## 3. 機能要件（Functional Requirements）

### FR-001: CSV ファイル読み込み

| 項目 | 内容 |
|------|------|
| **説明** | Perfmon からエクスポートされた CSV ファイルを読み込み、内部データモデルに変換する |
| **入力** | CSV ファイル（UTF-8 または Shift-JIS） |
| **出力** | 時系列データモデル（タイムスタンプ + カウンタ値の配列） |
| **受け入れ基準** | - 60時間 × 1分サンプリング × 12列のデータを10秒以内に読み込める<br>- ヘッダ行からカウンタ名を自動検出できる<br>- 欠損値（空セル）を適切に処理できる |

### FR-002: 時系列グラフ表示

| 項目 | 内容 |
|------|------|
| **説明** | 読み込んだデータを時系列グラフとして Web UI 上に表示する |
| **表示内容** | - 横軸: 時間<br>- 縦軸: カウンタ値（Private Bytes, Handle Count など） |
| **受け入れ基準** | - 複数カウンタを同時に表示できる（凡例付き）<br>- カウンタごとに表示/非表示を切り替えられる<br>- マウスオーバーで値を確認できる |

### FR-003: グラフ範囲選択

| 項目 | 内容 |
|------|------|
| **説明** | グラフの横軸（時間）の表示範囲をユーザーが自由に指定できる |
| **操作方法** | - 開始時刻・終了時刻を入力フィールドで指定<br>- または、グラフ上でドラッグ選択 |
| **受け入れ基準** | - 任意の時間範囲を選択できる<br>- 選択範囲が即座にグラフに反映される<br>- 全範囲表示にリセットできる |

### FR-004: 傾き算出・表示

| 項目 | 内容 |
|------|------|
| **説明** | 選択した時間範囲において、各カウンタの一次近似（線形回帰）傾きを算出し表示する |
| **算出方法** | 最小二乗法（OLS: Ordinary Least Squares） |
| **単位** | **KB/10min** |
| **受け入れ基準** | - 各カウンタの傾きが数値で表示される<br>- 傾き閾値（50 KB/10min）を超えた場合に警告色で表示される<br>- 傾きの正負（増加/減少）が視覚的にわかる |

### FR-005: 傾き閾値設定

| 項目 | 内容 |
|------|------|
| **説明** | 傾きの警告閾値をユーザーが設定できる |
| **初期値** | 50 KB/10min |
| **受け入れ基準** | - UI から閾値を変更できる<br>- 変更後、即座に警告表示が更新される |

### FR-006: グラフ画像出力

| 項目 | 内容 |
|------|------|
| **説明** | 表示中のグラフを画像ファイルとしてダウンロードできる |
| **出力形式** | PNG（推奨）、オプションで SVG |
| **受け入れ基準** | - 現在の表示範囲のグラフが画像として保存できる<br>- 凡例・軸ラベルが含まれる<br>- 解像度は印刷品質（300dpi 相当）を選択可能 |

### FR-007: 解析結果サマリ表示

| 項目 | 内容 |
|------|------|
| **説明** | 全カウンタの傾き一覧をテーブル形式で表示し、リーク疑いのあるプロセスを一目で確認できる |
| **表示項目** | カウンタ名、傾き（KB/10min）、判定結果（OK/警告） |
| **受け入れ基準** | - 傾き降順でソートできる<br>- 警告のあるカウンタが上位に表示される |

---

## 4. 非機能要件（Non-Functional Requirements）

### NFR-001: パフォーマンス

| 項目 | 基準 |
|------|------|
| CSV 読み込み | 3,600行 × 12列を **10秒以内** に処理 |
| グラフ描画 | 範囲変更後 **1秒以内** に再描画 |
| 傾き算出 | 選択範囲のデータに対して **500ms以内** に算出 |

### NFR-002: ユーザビリティ

| 項目 | 基準 |
|------|------|
| 学習コスト | 初回利用者が **5分以内** に基本操作を習得できる |
| レスポンシブ | デスクトップブラウザ（Chrome, Edge）で正常動作 |

### NFR-003: 保守性

| 項目 | 基準 |
|------|------|
| コード品質 | 主要ロジックにユニットテストを実装 |
| ドキュメント | API エンドポイントの説明を README に記載 |

### NFR-004: 拡張性

| 項目 | 基準 |
|------|------|
| カウンタ追加 | 新しいカウンタ種別を設定ファイルで追加可能 |
| 出力形式追加 | 新しいエクスポート形式（PDF 等）を追加しやすい設計 |

---

## 5. 入力仕様

### 5.1 CSV ファイル形式

Perfmon からエクスポートされる標準的な CSV 形式を想定する。

```csv
"(PDH-CSV 4.0) (Eastern Standard Time)(480)","\\SERVER\Process(process1)\Private Bytes","\\SERVER\Process(process1)\Handle Count","\\SERVER\Process(process2)\Private Bytes",...
"01/15/2026 10:00:00.000","1234567","150","2345678",...
"01/15/2026 10:01:00.000","1234600","151","2345700",...
```

| 項目 | 仕様 |
|------|------|
| エンコーディング | UTF-8 または Shift-JIS（自動判定） |
| 区切り文字 | カンマ（,） |
| 引用符 | ダブルクォート（"） |
| ヘッダ行 | 1行目（カウンタパスを含む） |
| タイムスタンプ列 | 1列目（MM/DD/YYYY HH:MM:SS.fff 形式） |
| 数値列 | 2列目以降（整数または小数） |

### 5.2 対応カウンタ（初期）

| カウンタ | パス例 |
|----------|--------|
| Private Bytes | `\Process(*)\Private Bytes` |
| Handle Count | `\Process(*)\Handle Count` |

※ 他のカウンタも読み込み可能だが、傾き閾値の意味付けは上記2種を主対象とする。

---

## 6. 出力仕様

### 6.1 画面出力

- 時系列グラフ（Chart.js または同等ライブラリ）
- 傾きサマリテーブル
- 警告アイコン・色による判定表示

### 6.2 ファイル出力

| 形式 | 内容 |
|------|------|
| PNG/SVG | グラフ画像 |
| CSV（将来） | 傾き計算結果のエクスポート |
| HTML（将来） | スタンドアロンレポート |

---

## 7. 技術スタック

| レイヤ | 技術 | 理由 |
|--------|------|------|
| バックエンド | ASP.NET Core Web API | C# の既存スキル活用、Windows 環境との親和性 |
| フロントエンド | React | Web UI による共有・ダッシュボード実現、学習価値 |
| グラフライブラリ | Chart.js（または Recharts） | React との統合が容易、画像エクスポート対応 |
| データ処理 | CsvHelper | .NET での CSV パース標準ライブラリ |
| 将来のDB | SQLite + EF Core | 軽量・ポータブル、履歴保存用 |

---

## 8. 制約事項

1. **MVP はローカル実行を前提**とする。認証・認可は実装しない。
2. **ブラウザは Chrome/Edge の最新版**を対象とする。IE/Safari は対象外。
3. **同時接続ユーザー数は 1名**を想定（シングルユーザーモード）。

---

## 9. 将来検討事項（フェーズ2以降）

| 機能 | 概要 |
|------|------|
| 自動収集ワークフロー | Windows タスクスケジューラ連携で Perfmon → CSV → 解析 → レポートを自動化 |
| 複数ファイル比較 | 異なる期間のデータを重ねて表示・比較 |
| アラート通知 | 傾き閾値超過時にメール/Teams 通知 |
| ダッシュボード共有 | 複数ユーザーでの閲覧（認証付き） |

---

## 10. 承認

| 役割 | 名前 | 日付 | 署名 |
|------|------|------|------|
| 作成者 | | 2026/01/31 | |
| レビュアー | | | |
| 承認者 | | | |

---

## 変更履歴

| バージョン | 日付 | 変更内容 |
|------------|------|----------|
| 1.0 | 2026/01/31 | 初版作成（草案） |
