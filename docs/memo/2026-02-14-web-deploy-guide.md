# Webアプリケーションのデプロイ方法 完全ガイド

作成日: 2026年2月14日

## 目次
1. [デプロイとは何か](#デプロイとは何か)
2. [このアプリの構成](#このアプリの構成)
3. [デプロイ方法の選択](#デプロイ方法の選択)
4. [具体的な手順](#具体的な手順)
5. [用語集](#用語集)

---

## デプロイとは何か

### デプロイの意味
**デプロイ（Deploy）** = アプリケーションを実際に使える状態にすること

開発中は自分のパソコンだけで動いていますが、デプロイすることで：
- 他の人がアクセスできるようになる
- ブラウザでURLを入力すれば使える状態になる
- サーバーで常時稼働させられる

### たとえ話
料理に例えると：
- **開発** = 自宅のキッチンで料理を作る
- **デプロイ** = レストランで料理を提供できるようにする

---

## このアプリの構成

現在のアプリは2つの部分から成り立っています：

### 1. フロントエンド（Frontend）
- **役割**: ユーザーが見る画面（見た目の部分）
- **技術**: React（リアクト）というJavaScriptのライブラリ
- **場所**: `src/frontend/` フォルダ
- **開発中の動き**: `npm run dev` で起動、ブラウザで表示

**簡単に言うと**: スマホアプリで言えば「画面の部分」

### 2. バックエンド（Backend）
- **役割**: データの処理や保存（裏側の処理）
- **技術**: ASP.NET Core（C#）
- **場所**: `src/backend/PerfmonAnalyzer.Api/` フォルダ
- **開発中の動き**: Visual Studio や `dotnet run` で起動

**簡単に言うと**: スマホアプリで言えば「サーバーの部分」

### 開発中の動き（現状）

```
あなたのPC
├── フロントエンド (localhost:5173) ← 画面を表示
│   ↓ API呼び出し
└── バックエンド (localhost:5272) ← データ処理
```

2つのプログラムが別々のポート（入口）で動いている状態です。

---

## デプロイ方法の選択

### 選択肢1: 統合型デプロイ（推奨・シンプル）★

**仕組み**:
```
サーバーPC (例: 192.168.1.100:5000)
└── ASP.NET Coreアプリ
    ├── 静的ファイル（Reactのビルド結果）← 画面
    └── API (/api/～) ← データ処理
```

- 1つのプログラムで全部動く
- アクセス先は1つだけ（例: `http://192.168.1.100:5000`）
- 設定がシンプル

**メリット**:
- ✅ 設定が簡単
- ✅ 管理が楽
- ✅ 初心者向き
- ✅ CORSの問題が起きない

**この方法を採用します！**

### 選択肢2: 分離型デプロイ（複雑）

```
サーバーPC
├── フロントエンド (ポート80) ← Nginx等
└── バックエンド (ポート5000) ← ASP.NET Core
```

- 2つのプログラムが別々に動く
- CORSという設定が必要（難しい）
- 大規模システム向き

**採用しない理由**: 初心者には複雑すぎる

---

## 具体的な手順

### ステップ1: フロントエンドのビルド（ビルド = 本番用に変換）

#### ビルドとは？
開発中のReactコードは、そのままではブラウザで動きません。
**ビルド** することで、HTML/CSS/JavaScriptの静的ファイルに変換します。

**たとえ話**: 
- 開発中 = 材料（野菜、肉など）
- ビルド後 = 完成した料理

#### やること

1. **フロントエンドフォルダに移動**
   ```powershell
   cd c:\workspace\010_programs\perfmonAnalyzer\src\frontend
   ```

2. **ビルドコマンド実行**
   ```powershell
   npm run build
   ```

3. **結果**
   `dist/` フォルダに静的ファイルが生成されます
   - `index.html` - メインのHTMLファイル
   - `assets/` - JavaScript、CSSファイル
   
   これらのファイルは「完成品」で、どのWebサーバーでも配信できます。

---

### ステップ2: バックエンドの設定変更

ASP.NET CoreアプリがReactの静的ファイルも配信できるようにします。

#### 必要な変更

**Program.cs** に以下を追加:

1. **静的ファイル機能を有効化**
   ```csharp
   app.UseStaticFiles();  // HTML、CSS、JSを配信できるようにする
   ```

2. **デフォルトファイル機能を有効化**
   ```csharp
   app.UseDefaultFiles();  // index.htmlを自動で表示
   ```

3. **フォールバック設定**（SPA対応）
   ```csharp
   app.MapFallbackToFile("index.html");  // どのURLも最初はindex.htmlを返す
   ```

#### SPA（Single Page Application）とは？

Reactアプリは **SPA** という仕組みです。

**従来のWebサイト**:
```
/about にアクセス → サーバーが about.html を返す
/contact にアクセス → サーバーが contact.html を返す
```

**SPA（React）**:
```
どのURLにアクセスでも → index.html を返す
↓
ブラウザ側のJavaScriptが画面を切り替える
```

だから `MapFallbackToFile("index.html")` が必要なのです！

---

### ステップ3: ファイル配置の自動化

毎回手動でファイルをコピーするのは面倒なので、スクリプトで自動化します。

#### デプロイスクリプト（deploy.ps1）

```powershell
# 1. フロントエンドをビルド
cd src/frontend
npm run build

# 2. バックエンドのwwwrootフォルダにコピー
# （wwwroot = ASP.NET Coreの静的ファイル置き場）
$distPath = "dist"
$wwwrootPath = "../backend/PerfmonAnalyzer.Api/wwwroot"

# 既存のwwwrootを削除
if (Test-Path $wwwrootPath) {
    Remove-Item $wwwrootPath -Recurse -Force
}

# ビルド結果をコピー
Copy-Item $distPath $wwwrootPath -Recurse
```

このスクリプトを実行すると、自動的に：
1. Reactアプリをビルド
2. 結果をバックエンドの適切な場所にコピー

---

### ステップ4: バックエンドの発行（Publish）

#### 発行とは？

開発中のコードを、サーバーで動かせる形にすること。

**dotnet publish** コマンドを使うと：
- 必要なファイルだけを集める
- 最適化された実行ファイルを作る
- すぐに配布できる状態にする

#### コマンド例

```powershell
cd src/backend/PerfmonAnalyzer.Api
dotnet publish -c Release -o ../../../publish
```

**オプション説明**:
- `-c Release` = 本番用設定でビルド（最適化される）
- `-o ../../../publish` = 出力先フォルダ

#### 結果

`publish/` フォルダに、以下が含まれます：
- 実行可能なDLLファイル
- 設定ファイル（appsettings.json）
- wwwroot（Reactの静的ファイル）
- .NETランタイム（必要な場合）

---

### ステップ5: サーバーでの実行

#### 開発用実行（テスト）

まずは自分のPCで試します：

```powershell
cd publish
dotnet PerfmonAnalyzer.Api.dll
```

これで起動します。デフォルトは `http://localhost:5000` です。

#### ネットワークからアクセス可能にする

**appsettings.json** を編集して、IPアドレスを指定：

```json
{
  "Urls": "http://0.0.0.0:5000"
}
```

**0.0.0.0 の意味**:
- `localhost` = 自分のPCからだけアクセス可能
- `0.0.0.0` = すべてのネットワークインターフェースでリッスン
  → 同じネットワーク内の他のPCからもアクセス可能

#### アクセス方法

同じネットワーク内の他のPCから：

```
http://192.168.1.100:5000
```

（192.168.1.100はサーバーPCのIPアドレス）

---

### ステップ6: Windows サービス化（オプション・上級者向け）

PCを再起動しても自動で起動するようにする方法です。

**Windowsサービス** として登録すると：
- Windows起動時に自動起動
- バックグラウンドで常時実行
- ログオンしなくても動く

これは後で必要になったら対応します。

---

## デプロイの全体フロー図

```
┌─────────────────────────────────────────────┐
│ 1. 開発完了                                  │
└─────────────────┬───────────────────────────┘
                  │
┌─────────────────▼───────────────────────────┐
│ 2. フロントエンドをビルド                     │
│    npm run build                            │
│    → dist/ フォルダに静的ファイル生成          │
└─────────────────┬───────────────────────────┘
                  │
┌─────────────────▼───────────────────────────┐
│ 3. 静的ファイルをバックエンドにコピー           │
│    dist/ → backend/wwwroot/                 │
└─────────────────┬───────────────────────────┘
                  │
┌─────────────────▼───────────────────────────┐
│ 4. バックエンドを発行                         │
│    dotnet publish                           │
│    → publish/ フォルダに実行可能ファイル生成    │
└─────────────────┬───────────────────────────┘
                  │
┌─────────────────▼───────────────────────────┐
│ 5. publish/ フォルダをサーバーPCにコピー       │
└─────────────────┬───────────────────────────┘
                  │
┌─────────────────▼───────────────────────────┐
│ 6. サーバーで実行                             │
│    dotnet PerfmonAnalyzer.Api.dll           │
└─────────────────┬───────────────────────────┘
                  │
┌─────────────────▼───────────────────────────┐
│ 7. ブラウザでアクセス                         │
│    http://192.168.1.100:5000                │
└─────────────────────────────────────────────┘
```

---

## 用語集

### API（エーピーアイ）
**Application Programming Interface**
プログラム同士が会話するための仕組み。
このアプリでは、Reactからバックエンドにデータを要求するときに使います。

例: `/api/data/counter-list` にアクセス → カウンター一覧を取得

### ビルド（Build）
ソースコードを実行可能な形式に変換すること。
Reactの場合、TypeScript/JSXを普通のJavaScriptに変換し、最適化します。

### 静的ファイル（Static Files）
変わらないファイルのこと。HTML、CSS、JavaScript、画像など。
サーバーはこれらをそのまま配信するだけ。

### 動的コンテンツ（Dynamic Content）
リクエストごとに内容が変わるもの。
APIのレスポンス（データ）など。

### ポート（Port）
プログラムがネットワーク通信を受け付ける「入口番号」。
例: 5000番ポート = 家の玄関の番号のようなもの

### localhost
自分のPC自身を指す特別なアドレス。
`http://localhost:5000` = 自分のPCの5000番ポート

### IPアドレス
ネットワーク上のPC住所。
例: `192.168.1.100` = ローカルネットワーク内のPC

### CORS（コルス）
**Cross-Origin Resource Sharing**
ブラウザのセキュリティ機能。
異なるドメイン/ポート間の通信を制限します。

例:
- `http://localhost:5173`（React）から
- `http://localhost:5272`（API）に
- データを要求 → CORSエラーが起きる可能性

統合型デプロイなら、同じオリジンになるのでCORSの問題が起きません。

### SPA（Single Page Application）
1つのHTMLページだけで動くWebアプリ。
ページ遷移時に画面全体をリロードせず、JavaScriptで部分的に書き換えます。

React、Vue、Angularなどがこの方式です。

### wwwroot
ASP.NET Coreの規約で、静的ファイルを置くフォルダ名。
このフォルダ内のファイルは自動的にWeb公開されます。

### Publish（発行）
アプリケーションを配布可能な形にまとめること。
開発中の余計なファイルを除外し、最適化します。

### ランタイム（Runtime）
プログラムを実行するための基盤ソフトウェア。
.NET Runtimeがあれば、C#で書かれたプログラムが動きます。

---

## トラブルシューティング

### ファイアウォールでブロックされる

**症状**: 他のPCからアクセスできない

**解決**:
```powershell
# Windows Defenderファイアウォールで5000番ポートを許可
New-NetFirewallRule -DisplayName "PerfmonAnalyzer" -Direction Inbound -Protocol TCP -LocalPort 5000 -Action Allow
```

### ポートが既に使用されている

**症状**: `Address already in use` エラー

**解決**: ポート番号を変更する
```json
{
  "Urls": "http://0.0.0.0:5001"
}
```

### 404 Not Found エラー

**症状**: `/about` などのページで404エラー

**原因**: SPAのフォールバック設定が無い

**解決**: `app.MapFallbackToFile("index.html");` を追加

---

## 次のステップ

1. ✅ デプロイ方法の理解
2. ⬜ 実際にデプロイスクリプトを作成
3. ⬜ バックエンドの設定変更
4. ⬜ テスト実行
5. ⬜ 本番環境へのデプロイ
6. ⬜ （オプション）Windowsサービス化

---

## 参考リンク

- [ASP.NET Core 静的ファイル](https://learn.microsoft.com/ja-jp/aspnet/core/fundamentals/static-files)
- [React Production Build](https://ja.react.dev/learn/start-a-new-react-project#building-for-production)
- [.NET アプリの発行](https://learn.microsoft.com/ja-jp/dotnet/core/deploying/)
